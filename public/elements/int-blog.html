<!-- <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet"> -->
<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/app-route/app-route.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/marked-element/marked-element.html">
<link href="/dependencies/prism.css" rel="stylesheet" />

<dom-module id="int-blog">
  <template>
    <style>
      :host {
        display: flex;
        justify-content: center;
      }

      #container {
        max-width: 800px;
        min-height: 50vh;
        display: flex;
        flex-direction: column;
        padding: 40px;
      }

      #breadcrumbs {
        padding: 20px 0;
      }

      marked-element {
        max-width: 100%;
      }

      img {
        max-width: 100%;
      }

    </style>

    <script src="/dependencies/prism.js"></script>

    <app-route route="{{route}}" pattern="/:year" active="{{yearActive}}" data="{{yearData}}" tail="{{yearTail}}"></app-route>
    <app-route route="{{yearTail}}" pattern="/:month" active="{{monthActive}}" data="{{monthData}}" tail="{{monthTail}}"></app-route>
    <app-route route="{{monthTail}}" pattern="/:slug" active="{{slugActive}}" data="{{slugData}}" tail="{{slugTail}}"></app-route>

    <iron-ajax
      auto
      url="[[requestUrl]]"
      handle-as="text"
      on-response="setMarkdown"
      on-error="reportNotFound"
      debounce-duration="300">
    </iron-ajax>

    <div id="container">
      <div id="breadcrumbs">[[yearData.year]] [[monthData.month]]</div>
      <marked-element markdown=[[content]]></marked-element>
      <prism-highlighter></prism-highlighter>
    </div>

  </template>

  <script>
    Polymer({
      is: 'int-blog',
      properties: {
        requestUrl: {
          type: String,
          computed: 'computeRequestUrl(blog, route.path)'
        },
        content: {
          type: String
        }
      },
      computeRequestUrl: function(blog, path) {
        if(path === "") path = "/dir";
        // if(!this.yearData.year || this.yearData.year === '') path += "/dir";
        // else if(!this.monthData.month || this.monthData.month === '') path += "/dir";
        // else if(!this.slugData.slug || this.slugData.slug === '') path += "/dir";
        // console.log(path);
        return "/blogs/" + blog + path + ".md";
      },
      setMarkdown: function(e, resp) {
        if(resp.response.includes('<html>')) return;
        this.set('content', resp.response);
      },
      reportNotFound: function(e, resp) {
        this.set('content', "Post not found.")
      }
    });

  </script>
</dom-module>
